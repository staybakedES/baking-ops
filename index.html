<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bakery Ordering System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .order-card, .task-card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .order-card:hover, .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<!-- This message will show if the JavaScript fails to load -->
<div id="initial-message" class="flex flex-col items-center justify-center min-h-screen text-center text-gray-500">
    <p>Loading application...</p>
</div>

<!-- This is where the React app will be rendered -->
<div id="root" style="display: none;"></div>

<!-- Load React and ReactDOM from CDN -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    'use strict';

    const { useState, useEffect } = React;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // IMPORTANT: Paste your Firebase config object here to make the app work outside of the Canvas environment.
    const myFirebaseConfig = {
        apiKey: "AIzaSyBIdpCnLgzYPTs8jgz4sjSYmSr_2T6dTI4",
        authDomain: "order-management-8c278.firebaseapp.com",
        projectId: "order-management-8c278",
        storageBucket: "order-management-8c278.firebasestorage.app",
        messagingSenderId: "618028270118",
        appId: "1:618028270118:web:ac7205417dad37cc4b5ce7"
    };

    // Firebase instances
    let app, db, auth;

    // Main App component
    function App() {
        const [orders, setOrders] = useState([]);
        const [isNewOrderModalOpen, setIsNewOrderModalOpen] = useState(false);
        const [isAuthReady, setIsAuthReady] = useState(false);
        const [userId, setUserId] = useState(null);
        const [statusMessage, setStatusMessage] = useState('');
        const [newOrder, setNewOrder] = useState({
            client: '',
            dueDate: '',
            notes: '',
            orderItems: ''
        });

        // This effect handles authentication and Firestore setup
        useEffect(() => {
            const signIn = async () => {
                try {
                    if (initialAuthToken) {
                        await auth.signInWithCustomToken(initialAuthToken);
                    } else {
                        await auth.signInAnonymously();
                    }
                } catch (error) {
                    setStatusMessage(`Authentication failed. Error: ${error.message}`);
                    console.error("Firebase authentication error:", error);
                }
            };

            const unsubscribeAuth = auth.onAuthStateChanged(user => {
                if (user) {
                    setUserId(user.uid);
                    setIsAuthReady(true);
                    setStatusMessage('');
                } else {
                    setUserId(null);
                    setIsAuthReady(false);
                    setStatusMessage('User is not signed in. Attempting to sign in...');
                    signIn();
                }
            });

            return () => {
                unsubscribeAuth();
            };
        }, []);

        // This effect fetches all orders and their tasks
        useEffect(() => {
            if (!isAuthReady || !db || !userId) return;

            const ordersCollectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('orders');
            const unsubscribeSnapshot = ordersCollectionRef.onSnapshot(
                async (snapshot) => {
                    const fetchedOrders = [];
                    for (const doc of snapshot.docs) {
                        const orderData = { id: doc.id, ...doc.data(), tasks: [] };
                        
                        // Fetch tasks for each order
                        const tasksSnapshot = await doc.ref.collection('tasks').get();
                        orderData.tasks = tasksSnapshot.docs.map(taskDoc => ({
                            id: taskDoc.id,
                            ...taskDoc.data()
                        }));

                        fetchedOrders.push(orderData);
                    }
                    setOrders(fetchedOrders);
                    setStatusMessage('');
                },
                (error) => {
                    console.error("Error fetching orders:", error);
                    setStatusMessage(`Error fetching data: ${error.message}`);
                }
            );

            return () => unsubscribeSnapshot();
        }, [isAuthReady, userId]);

        const handleNewOrderChange = (e) => {
            const { name, value } = e.target;
            setNewOrder(prev => ({ ...prev, [name]: value }));
        };

        const handleAddOrder = async () => {
            if (!db || !userId) {
                setStatusMessage('Authentication not ready. Please wait.');
                return;
            }
            if (!newOrder.client || !newOrder.dueDate || !newOrder.orderItems) {
                setStatusMessage('Please fill in all required fields.');
                return;
            }

            const ordersCollectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('orders');
            try {
                // First, add the main order document
                const newOrderRef = await ordersCollectionRef.add({
                    client: newOrder.client,
                    dueDate: newOrder.dueDate,
                    notes: newOrder.notes,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                });

                // Then, create tasks from the order items
                const items = newOrder.orderItems.split('\n').map(item => item.trim()).filter(item => item.length > 0);
                const tasksCollectionRef = newOrderRef.collection('tasks');
                for (const item of items) {
                    await tasksCollectionRef.add({
                        description: item,
                        assignedTo: null, // Initially unassigned
                        status: 'Pending',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    });
                }

                setStatusMessage('Order and tasks added successfully!');
                setNewOrder({ client: '', dueDate: '', notes: '', orderItems: '' });
                setIsNewOrderModalOpen(false);
            } catch (error) {
                console.error("Error adding order: ", error);
                setStatusMessage(`Error adding order: ${error.message}`);
            }
        };

        const handleUpdateTaskAssignment = async (orderId, taskId, newAssignment) => {
            if (!db || !userId) {
                setStatusMessage('Authentication not ready. Please wait.');
                return;
            }
            const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('orders').doc(orderId).collection('tasks').doc(taskId);
            try {
                await docRef.update({ assignedTo: newAssignment });
                setStatusMessage('Task assignment updated!');
            } catch (error) {
                console.error("Error updating task assignment: ", error);
                setStatusMessage(`Error updating task assignment: ${error.message}`);
            }
        };

        const handleUpdateTaskStatus = async (orderId, taskId, currentStatus) => {
            if (!db || !userId) {
                setStatusMessage('Authentication not ready. Please wait.');
                return;
            }
            const newStatus = currentStatus === 'Pending' ? 'Completed' : 'Pending';
            const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('orders').doc(orderId).collection('tasks').doc(taskId);
            try {
                await docRef.update({ status: newStatus });
                setStatusMessage('Task status updated!');
            } catch (error) {
                console.error("Error updating task status: ", error);
                setStatusMessage(`Error updating task status: ${error.message}`);
            }
        };

        const handleDeleteOrder = async (id) => {
            if (!db || !userId) {
                setStatusMessage('Authentication not ready. Please wait.');
                return;
            }
            // Note: This won't delete subcollections in Firestore. A more complex function is needed for that.
            const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('orders').doc(id);
            try {
                await docRef.delete();
                setStatusMessage('Order deleted successfully!');
            } catch (error) {
                console.error("Error deleting order: ", error);
                setStatusMessage(`Error deleting order: ${error.message}`);
            }
        };

        const getTaskStatusColor = (status) => {
            return status === 'Completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
        };

        const renderNewOrderModal = () => isNewOrderModalOpen && React.createElement(
            'div',
            { className: 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50' },
            React.createElement(
                'div',
                { className: 'relative bg-white p-8 rounded-xl shadow-xl w-full max-w-md m-4' },
                React.createElement('h2', { className: 'text-2xl font-bold mb-6 text-center' }, 'Add New Order'),
                React.createElement(
                    'form',
                    { onSubmit: (e) => { e.preventDefault(); handleAddOrder(); } },
                    React.createElement('div', { className: 'mb-4' }, React.createElement('label', { className: 'block text-gray-700 text-sm font-bold mb-2', htmlFor: 'client' }, 'Client Name'), React.createElement('input', { type: 'text', id: 'client', name: 'client', value: newOrder.client, onChange: handleNewOrderChange, className: 'shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline', required: true })),
                    React.createElement('div', { className: 'mb-4' }, React.createElement('label', { className: 'block text-gray-700 text-sm font-bold mb-2', htmlFor: 'dueDate' }, 'Due Date'), React.createElement('input', { type: 'date', id: 'dueDate', name: 'dueDate', value: newOrder.dueDate, onChange: handleNewOrderChange, className: 'shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline', required: true })),
                    React.createElement('div', { className: 'mb-4' }, React.createElement('label', { className: 'block text-gray-700 text-sm font-bold mb-2', htmlFor: 'orderItems' }, 'Order Items (One per line)'), React.createElement('textarea', { id: 'orderItems', name: 'orderItems', value: newOrder.orderItems, onChange: handleNewOrderChange, className: 'shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24 resize-none', required: true })),
                    React.createElement('div', { className: 'mb-6' }, React.createElement('label', { className: 'block text-gray-700 text-sm font-bold mb-2', htmlFor: 'notes' }, 'Notes'), React.createElement('textarea', { id: 'notes', name: 'notes', value: newOrder.notes, onChange: handleNewOrderChange, className: 'shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24 resize-none' })),
                    React.createElement('div', { className: 'flex items-center justify-between' }, React.createElement('button', { type: 'submit', className: 'bg-blue-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg hover:bg-blue-700 transition duration-300 focus:outline-none focus:shadow-outline' }, 'Add Order'), React.createElement('button', { type: 'button', onClick: () => setIsNewOrderModalOpen(false), className: 'bg-gray-400 text-white font-bold py-2 px-4 rounded-xl shadow-lg hover:bg-gray-500 transition duration-300 focus:outline-none focus:shadow-outline' }, 'Cancel'))
                )
            )
        );

        // Main render function
        return React.createElement(
            'div',
            { className: 'min-h-screen bg-gray-100 p-8 flex flex-col items-center' },
            React.createElement(
                'header',
                { className: 'w-full max-w-4xl text-center py-6' },
                React.createElement('h1', { className: 'text-4xl font-bold text-gray-800 mb-2' }, 'Bakery Order System'),
                React.createElement('p', { className: 'text-gray-600 mb-4' }, 'Manage orders and tasks for your bakers. User ID: ', userId || 'Loading...'),
                React.createElement('button', { onClick: () => setIsNewOrderModalOpen(true), className: 'bg-blue-600 text-white font-semibold py-2 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition duration-300' }, React.createElement('i', { className: 'fas fa-plus mr-2' }), ' Add New Order')
            ),
            React.createElement(
                'main',
                { className: 'w-full max-w-4xl mt-8' },
                statusMessage && React.createElement('div', { className: 'bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg relative mb-4' }, statusMessage),
                !isAuthReady || !userId ? (
                    React.createElement('div', { className: 'flex flex-col items-center justify-center py-20' }, React.createElement('div', { className: 'loading-spinner mb-4' }), React.createElement('p', { className: 'text-gray-500' }, 'Connecting to Firebase...'))
                ) : orders.length === 0 ? (
                    React.createElement('div', { className: 'text-center text-gray-500 py-10' }, React.createElement('i', { className: 'fas fa-box-open text-6xl mb-4' }), React.createElement('p', null, 'You have no orders yet. Add a new one to get started!'))
                ) : (
                    React.createElement(
                        'div',
                        { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' },
                        orders.map(order =>
                            React.createElement(
                                'div',
                                { key: order.id, className: 'order-card bg-white p-6 rounded-2xl shadow-md flex flex-col justify-between animate-fadeIn' },
                                React.createElement('h3', { className: 'text-xl font-semibold text-gray-900 truncate' }, 'Order for ', order.client),
                                React.createElement('p', { className: 'text-sm text-gray-500' }, 'Due: ', order.dueDate),
                                order.notes && React.createElement('p', { className: 'text-sm text-gray-500 mt-2 italic' }, 'Notes: ', order.notes),
                                React.createElement(
                                    'div',
                                    { className: 'mt-4' },
                                    React.createElement('h4', { className: 'font-semibold text-gray-700' }, 'Tasks'),
                                    order.tasks.length > 0 ? (
                                        React.createElement(
                                            'ul',
                                            { className: 'mt-2 space-y-2' },
                                            order.tasks.map(task =>
                                                React.createElement(
                                                    'li',
                                                    { key: task.id, className: `p-3 rounded-lg flex flex-col sm:flex-row items-start sm:items-center justify-between ${getTaskStatusColor(task.status)}` },
                                                    React.createElement('div', { className: 'flex-1 mb-2 sm:mb-0' },
                                                        React.createElement('p', { className: 'text-sm font-medium' }, task.description),
                                                        React.createElement('p', { className: 'text-xs text-gray-600' }, task.assignedTo ? `Assigned to: ${task.assignedTo}` : 'Unassigned')
                                                    ),
                                                    React.createElement(
                                                        'div',
                                                        { className: 'flex flex-wrap items-center space-x-2' },
                                                        React.createElement(
                                                            'select',
                                                            {
                                                                value: task.assignedTo || '',
                                                                onChange: (e) => handleUpdateTaskAssignment(order.id, task.id, e.target.value),
                                                                className: 'text-xs p-1 border rounded-lg'
                                                            },
                                                            React.createElement('option', { value: '' }, 'Unassign'),
                                                            React.createElement('option', { value: 'Baker 1' }, 'Baker 1'),
                                                            React.createElement('option', { value: 'Baker 2' }, 'Baker 2')
                                                        ),
                                                        React.createElement(
                                                            'button',
                                                            {
                                                                onClick: () => handleUpdateTaskStatus(order.id, task.id, task.status),
                                                                className: `p-2 rounded-full transition duration-300 ${task.status === 'Pending' ? 'text-green-600 hover:bg-green-200' : 'text-yellow-600 hover:bg-yellow-200'}`
                                                            },
                                                            React.createElement('i', { className: `fas ${task.status === 'Pending' ? 'fa-check' : 'fa-undo-alt'}` })
                                                        )
                                                    )
                                                )
                                            )
                                        )
                                    ) : (
                                        React.createElement('p', { className: 'text-sm text-gray-500 italic mt-2' }, 'No tasks for this order. (Please enter items in the order field)')
                                    )
                                ),
                                React.createElement(
                                    'div',
                                    { className: 'flex items-center mt-6 space-x-2' },
                                    React.createElement(
                                        'button',
                                        {
                                            onClick: () => handleDeleteOrder(order.id),
                                            className: 'bg-red-500 text-white p-3 rounded-full hover:bg-red-600 transition duration-300'
                                        },
                                        React.createElement('i', { className: 'fas fa-trash' })
                                    )
                                )
                            )
                        )
                    )
                ),
                renderNewOrderModal()
            )
        );
    }

    // Use window.onload to ensure the entire page is loaded before trying to render the React app.
    window.onload = function() {
        try {
            // First, initialize Firebase outside the React component.
            if (typeof __firebase_config !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                app = firebase.initializeApp(firebaseConfig);
            } else if (myFirebaseConfig.projectId) {
                app = firebase.initializeApp(myFirebaseConfig);
            } else {
                throw new Error("Firebase configuration is missing.");
            }
            db = firebase.firestore();
            auth = firebase.auth();
            
            // Hide the initial loading message.
            document.getElementById('initial-message').style.display = 'none';

            // Show the root div
            document.getElementById('root').style.display = 'block';

            // Render the App component into the root div.
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(React.createElement(App));
        } catch (error) {
            console.error("Application failed to render:", error);
            const rootElement = document.getElementById('root');
            const initialMessageElement = document.getElementById('initial-message');
            
            if (initialMessageElement) {
                initialMessageElement.innerHTML = `
                    <div class="p-8 text-center text-red-600">
                        <h1 class="text-2xl font-bold mb-2">Fatal Error</h1>
                        <p>The application could not be loaded. Please check the console for details.</p>
                        <p class="mt-2 text-sm text-gray-500">Error: ${error.message}</p>
                    </div>
                `;
                initialMessageElement.style.display = 'block';
            } else if (rootElement) {
                rootElement.innerHTML = `
                    <div class="p-8 text-center text-red-600">
                        <h1 class="text-2xl font-bold mb-2">Fatal Error</h1>
                        <p>The application could not be loaded. Please check the console for details.</p>
                        <p class="mt-2 text-sm text-gray-500">Error: ${error.message}</p>
                    </div>
                `;
                rootElement.style.display = 'block';
            }
        }
    };
</script>
</body>
</html>
